<!doctype html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="JWT 인증 / 인가" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="Spring Security와 JWT를 활용하여 자체 로그인/로그아웃을 구현하기" /><meta property="og:description" content="Spring Security와 JWT를 활용하여 자체 로그인/로그아웃을 구현하기" /><link rel="canonical" href="https://backnback.github.io/posts/jwt/" /><meta property="og:url" content="https://backnback.github.io/posts/jwt/" /><meta property="og:site_name" content="리버" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-01-26T11:00:00+09:00" /><meta property="og:image" content="https://backnback.github.io/assets/img/profile.jpg" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://backnback.github.io/assets/img/profile.jpg" /><meta property="twitter:title" content="JWT 인증 / 인가" /><meta name="google-site-verification" content="googlea7baca2291ff3812.html" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-01-26T21:20:42+09:00","datePublished":"2025-01-26T11:00:00+09:00","description":"Spring Security와 JWT를 활용하여 자체 로그인/로그아웃을 구현하기","headline":"JWT 인증 / 인가","mainEntityOfPage":{"@type":"WebPage","@id":"https://backnback.github.io/posts/jwt/"},"url":"https://backnback.github.io/posts/jwt/"}</script><title>JWT 인증 / 인가 | 리버</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="리버"><meta name="application-name" content="리버"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/ko.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script async src="/assets/js/data/mathjax.js"></script> <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script> let pv = document.getElementById('pageviews'); if (pv !== null) { const uri = location.pathname.replace(/\/$/, ''); const url = `https://blogcounterbacknback.goatcounter.com/counter/${encodeURIComponent(uri)}.json`; fetch(url) .then((response) => response.json()) .then((data) => { const count = data.count.replace(/\s/g, ''); pv.innerText = new Intl.NumberFormat().format(count); }) .catch((error) => { pv.innerText = '1'; }); } </script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-9ZSXFFWEB4"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-9ZSXFFWEB4'); }); </script> <script async src="https://gc.zgo.at/count.js" data-goatcounter="https://blogcounterbacknback.goatcounter.com/count" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/profile.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">리버</a><p class="site-subtitle fst-italic mb-0">Backend 개발자</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>홈</span> </a><li class="nav-item"> <a href="/posts/" class="nav-link"> <i class="fa-fw fas fa-feather-alt"></i> <span>게시글</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>카테고리</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>태그</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>아카이브</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>정보</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/backnback" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['garam8796','naver.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">홈</a> </span> <span>JWT 인증 / 인가</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> 포스트</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="검색..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">취소</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>JWT 인증 / 인가</h1><p class="post-desc fw-light mb-4">Spring Security와 JWT를 활용하여 자체 로그인/로그아웃을 구현하기</p><div class="post-meta text-muted"> <span> 게시 <time data-ts="1737856800" data-df="YYYY/MM/DD" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2025/01/26 </time> </span> <span> 업데이트 <time data-ts="1737894042" data-df="YYYY/MM/DD" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2025/01/26 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/backnback">이가람</a> </em> </span><div> <span> <em id="pageviews"> <i class="fas fa-spinner fa-spin small"></i> </em> 조회 </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="6959 단어" > <em>38 분</em>읽는 시간</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">JWT 인증 / 인가</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">바로가기</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">JWT 인증 / 인가</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h3 id="멋쟁이-사자처럼-수업-링크"><span class="me-2">멋쟁이 사자처럼 수업 링크</span><a href="#멋쟁이-사자처럼-수업-링크" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://www.youtube.com/playlist?list=PLMzNIYZSiq7aWqMXs8_PP-UODiNVbDf0k">루프코딩 연구소 재생목록</a></ul><p><br /> <br /> <br /></p><h2 id="1-article-메인-모듈-구현"><span class="me-2">1. article 메인 모듈 구현</span><a href="#1-article-메인-모듈-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="-article-메인-모듈의-article-서브-모듈-구현"><span class="me-2">🔆 article 메인 모듈의 article 서브 모듈 구현</span><a href="#-article-메인-모듈의-article-서브-모듈-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="path">ApiV1ArticleController</span><ul><li><p><span class="red">REST API Method</span>에 따라 생성</p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.article.article.controller</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">...</span>
        
  <span class="nd">@RestController</span>
  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/v1/articles"</span><span class="o">)</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiV1ArticleController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArticleService</span> <span class="n">articleService</span><span class="o">;</span>
        
    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ArticleDto</span><span class="o">&gt;</span> <span class="nf">getArticles</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Article</span><span class="o">&gt;</span> <span class="n">articles</span> <span class="o">=</span> <span class="n">articleService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ArticleDto</span><span class="o">&gt;</span> <span class="n">articleDtoList</span> <span class="o">=</span> <span class="n">articles</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">ArticleDto:</span><span class="o">:</span><span class="k">new</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
        
      <span class="k">return</span> <span class="n">articleDtoList</span><span class="o">;</span>
    <span class="o">}</span>
        
    <span class="nd">@GetMapping</span><span class="o">({</span><span class="s">"/{id}"</span><span class="o">})</span>
    <span class="kd">private</span> <span class="nc">ArticleDto</span> <span class="nf">getArticle</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Article</span> <span class="n">article</span> <span class="o">=</span> <span class="n">articleService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ArticleDto</span><span class="o">(</span><span class="n">article</span><span class="o">);</span>
    <span class="o">}</span>
        
    <span class="nd">@PostMapping</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">ArticleDto</span><span class="o">&gt;</span> <span class="nf">writeArticle</span><span class="o">(</span>
        <span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">ArticleWriteRequest</span> <span class="n">articleWriteRequest</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Article</span> <span class="n">article</span> <span class="o">=</span>
          <span class="n">articleService</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">articleWriteRequest</span><span class="o">.</span><span class="na">getTitle</span><span class="o">(),</span> <span class="n">articleWriteRequest</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
            
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"게시글이 작성에 성공하였습니다."</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ArticleDto</span><span class="o">(</span><span class="n">article</span><span class="o">));</span>
    <span class="o">}</span>
        
    <span class="nd">@PatchMapping</span><span class="o">({</span><span class="s">"/{id}"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">ArticleDto</span><span class="o">&gt;</span> <span class="nf">updateArticle</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
        <span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">ArticleModifyRequest</span> <span class="n">articleModifyRequest</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Article</span> <span class="n">article</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">articleService</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
      <span class="nc">Article</span> <span class="n">modifiedArticle</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">articleService</span><span class="o">.</span><span class="na">modify</span><span class="o">(</span><span class="n">article</span><span class="o">,</span> <span class="n">articleModifyRequest</span><span class="o">.</span><span class="na">getTitle</span><span class="o">(),</span>
          <span class="n">articleModifyRequest</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
        
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"게시글이 수정에 성공하였습니다."</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ArticleDto</span><span class="o">(</span><span class="n">modifiedArticle</span><span class="o">));</span>
    <span class="o">}</span>
        
    <span class="nd">@DeleteMapping</span><span class="o">({</span><span class="s">"/{id}"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">deleteArticle</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">articleService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"게시글이 삭제에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div></div></details></ul></ul><p><br /></p><p><br /></p><ul><li><strong><span class="greenback">REST API 메서드</span></strong><ul><li><strong><span class="blue">CREATE</span></strong><ul><li><code class="language-plaintext highlighter-rouge">POST</code>   -   생성</ul><li><strong><span class="pink">READ</span></strong><ul><li><code class="language-plaintext highlighter-rouge">GET</code>   -   단건, 다건 조회</ul><li><strong><span class="green">UPDATE</span></strong><ul><li><code class="language-plaintext highlighter-rouge">PUT/FATCH</code>   -   업데이트</ul><li><strong><span class="purple">DELETE</span></strong><ul><li><code class="language-plaintext highlighter-rouge">DELETET</code>   -   삭제</ul></ul></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">ApiV1ArticleService</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.article.article.service</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">...</span>
    
  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="nd">@Service</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArticleService</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArticleRepository</span> <span class="n">articleRepository</span><span class="o">;</span>
    
      <span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="nc">Article</span> <span class="nf">write</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Article</span> <span class="n">article</span> <span class="o">=</span> <span class="nc">Article</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
              <span class="o">.</span><span class="na">author</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">id</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">build</span><span class="o">())</span>
              <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="n">title</span><span class="o">)</span>
              <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">content</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    
          <span class="k">return</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">article</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Article</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="nc">Article</span> <span class="nf">modify</span><span class="o">(</span><span class="nc">Article</span> <span class="n">article</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">article</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">title</span><span class="o">);</span>
          <span class="n">article</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
    
          <span class="k">return</span> <span class="n">article</span><span class="o">;</span>
      <span class="o">}</span>
    
      <span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">modifyComment</span><span class="o">(</span><span class="nc">ArticleComment</span> <span class="n">comment</span><span class="o">,</span> <span class="nc">String</span> <span class="n">commentBody</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">comment</span><span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">commentBody</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Article</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
      <span class="o">}</span>
    
      <span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">articleRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div></div></details></ul><p><br /> <br /></p><ul><li><p><span class="path">ArticleRepository</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.article.article.repository</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.article.article.entity.Article</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
    
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ArticleRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Article</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="o">}</span>
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">Article</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.article.article.entity</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">...</span>
    
  <span class="nd">@Entity</span>
  <span class="nd">@Setter</span>
  <span class="nd">@Getter</span>
  <span class="nd">@AllArgsConstructor</span>
  <span class="nd">@NoArgsConstructor</span>
  <span class="nd">@SuperBuilder</span>
  <span class="nd">@ToString</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Article</span> <span class="kd">extends</span> <span class="nc">BaseEntity</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>
    
      <span class="nd">@JsonIgnore</span>
      <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">fetch</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
      <span class="kd">private</span> <span class="nc">Member</span> <span class="n">author</span><span class="o">;</span>
    
      <span class="nd">@JsonIgnore</span>
      <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"article"</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="no">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// fetch = FetchType.LAZY</span>
      <span class="nd">@Builder</span><span class="o">.</span><span class="na">Default</span>
      <span class="nd">@ToString</span><span class="o">.</span><span class="na">Exclude</span>
      <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ArticleComment</span><span class="o">&gt;</span> <span class="n">comments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addComment</span><span class="o">(</span><span class="nc">Member</span> <span class="n">memberAuthor</span><span class="o">,</span> <span class="nc">String</span> <span class="n">commentBody</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">ArticleComment</span> <span class="n">comment</span> <span class="o">=</span> <span class="nc">ArticleComment</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
              <span class="o">.</span><span class="na">article</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
              <span class="o">.</span><span class="na">author</span><span class="o">(</span><span class="n">memberAuthor</span><span class="o">)</span>
              <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">commentBody</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    
          <span class="n">comments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">comment</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeComment</span><span class="o">(</span><span class="nc">ArticleComment</span> <span class="n">articleComment</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">comments</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">articleComment</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="nd">@JsonIgnore</span>
      <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"article"</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="no">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
      <span class="nd">@Builder</span><span class="o">.</span><span class="na">Default</span>
      <span class="nd">@ToString</span><span class="o">.</span><span class="na">Exclude</span>
      <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ArticleTag</span><span class="o">&gt;</span> <span class="n">tags</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addTag</span><span class="o">(</span><span class="nc">String</span> <span class="n">tagContent</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">ArticleTag</span> <span class="n">tag</span> <span class="o">=</span> <span class="nc">ArticleTag</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
              <span class="o">.</span><span class="na">article</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
              <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">tagContent</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="n">tags</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tag</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addTags</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">tagContents</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">tagContent</span> <span class="o">:</span> <span class="n">tagContents</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">addTag</span><span class="o">(</span><span class="n">tagContent</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span>
    
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTagsStr</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">tagsStr</span> <span class="o">=</span> <span class="n">tags</span>
              <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
              <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">ArticleTag:</span><span class="o">:</span><span class="n">getContent</span><span class="o">)</span>
              <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">" #"</span><span class="o">));</span>
    
          <span class="k">if</span> <span class="o">(</span><span class="n">tagsStr</span><span class="o">.</span><span class="na">isBlank</span><span class="o">())</span> <span class="o">{</span>
              <span class="k">return</span> <span class="s">""</span><span class="o">;</span>
          <span class="o">}</span>
    
          <span class="k">return</span> <span class="s">"#"</span> <span class="o">+</span> <span class="n">tagsStr</span><span class="o">;</span>
    
      <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-valid-애노테이션-추가"><span class="me-2">🔆 @Valid 애노테이션 추가</span><a href="#-valid-애노테이션-추가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="red">Validation 의존성</span> 추가<ul><li><span class="blue">데이터 검증</span>할 때 사용하는 라이브러리<ul><li><p><span class="path">build.gradle</span></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  implementation 'org.springframework.boot:spring-boot-starter-validation'
</pre></table></code></div></div></ul></ul><p><br /></p><ul><li>필요한 데이터가 들어오지 않으면 <span class="red">사전에 처리</span>한다.<li><strong><code class="language-plaintext highlighter-rouge">@NotBlank</code></strong><li><strong><code class="language-plaintext highlighter-rouge">@Valid</code></strong><li><code class="language-plaintext highlighter-rouge">@NotBlank</code>를 <span class="pink">개별 DTO 필드</span>(필수 항목)에 추가하고 해당 <span class="instance">DTO</span>를 Controller 클래스의 메서드에서 <span class="blue">파라미터</span>로 받을 때 <code class="language-plaintext highlighter-rouge">@Valid</code>를 사용하여 검증할 수 있게 한다.</ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-articleservice-삭제-transactional-애노테이션-추가"><span class="me-2">🔆 ArticleService 삭제 @Transactional 애노테이션 추가</span><a href="#-articleservice-삭제-transactional-애노테이션-추가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><strong><code class="language-plaintext highlighter-rouge">@Transactional(readOnly = true)</code></strong><ul><li><span class="red">클래스</span>에 <code class="language-plaintext highlighter-rouge">readOnly</code>를 사용하고 <span class="blue">생성, 수정, 삭제 메서드</span>에 <code class="language-plaintext highlighter-rouge">@Transactional</code> 설정을 하지 않으면 <span class="line">조회만 할 수 있다.</span><ul><li>즉, <span class="red">생성, 수정, 삭제</span>의 경우 <code class="language-plaintext highlighter-rouge">@Transactional</code> 설정 필요   (<span class="pink">데이터 변경이 가능</span>해진다)</ul><li><p><span class="path">ArticleService</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="nd">@Service</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArticleService</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArticleRepository</span> <span class="n">articleRepository</span><span class="o">;</span>
        
  	<span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="nc">Article</span> <span class="nf">write</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Article</span> <span class="n">article</span> <span class="o">=</span> <span class="nc">Article</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
              <span class="o">.</span><span class="na">author</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">id</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="na">build</span><span class="o">())</span>
              <span class="o">.</span><span class="na">title</span><span class="o">(</span><span class="n">title</span><span class="o">)</span>
              <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">content</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        
          <span class="k">return</span> <span class="n">articleRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">article</span><span class="o">);</span>
      <span class="o">}</span>
        
  <span class="o">...</span>
</pre></table></code></div></div><ul><li>이렇게 생성 메서드는 <code class="language-plaintext highlighter-rouge">@Transactional</code> 애노테이션을 추가해야 한다.</ul></ul></ul><p><br /> <br /> <br /> <br /></p><h2 id="2-회원가입-구현"><span class="me-2">2. 회원가입 구현</span><a href="#2-회원가입-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="-전체-최종-코드"><span class="me-2">🔆 전체 최종 코드</span><a href="#-전체-최종-코드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><span class="path">ApiV1MemberController</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.member.member.controller</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.dto.MemberDto</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.dto.MemberRequest</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.entity.Member</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.service.MemberService</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.jwt.JwtProvider</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.rsData.RsData</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.servlet.http.Cookie</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.servlet.http.HttpServletRequest</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.servlet.http.HttpServletResponse</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.validation.Valid</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
    
  <span class="nd">@RestController</span>
  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/v1/members"</span><span class="o">)</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiV1MemberController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtProvider</span> <span class="n">jwtProvider</span><span class="o">;</span>
    
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/signup"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="nf">signup</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">memberRequest</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"회원가입에 성공하였습니다."</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MemberDto</span><span class="o">(</span><span class="n">member</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">,</span>
        <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getMember</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    
      <span class="c1">// 토큰 생성</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genAccessToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    
      <span class="c1">// 응답 데이터에 accessToken 이름으로 토큰을 발급</span>
      <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setSecure</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    
      <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="na">getRefreshToken</span><span class="o">();</span>
      <span class="nc">Cookie</span> <span class="n">refreshTokenCookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"refreshToken"</span><span class="o">,</span> <span class="n">refreshToken</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setSecure</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">refreshTokenCookie</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"로그인에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">logout</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    
      <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    
      <span class="nc">Cookie</span> <span class="n">refreshTokenCookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"refreshToken"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">refreshTokenCookie</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"로그아웃에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/me"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="nf">me</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
      <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    
      <span class="k">for</span> <span class="o">(</span><span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">accessToken</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">getClaims</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
    
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">memberService</span><span class="o">.</span><span class="na">getMember</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nf">RsData</span><span class="o">(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"회원정보 조회 성공"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MemberDto</span><span class="o">(</span><span class="n">member</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">MemberService</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.member.member.service</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.entity.Member</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.repository.MemberRepository</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.jwt.JwtProvider</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.rsData.RsData</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.security.SecurityUser</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
    
  <span class="nd">@Service</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtProvider</span> <span class="n">jwtProvider</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">join</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="nc">CheckedSignUpMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    
      <span class="k">if</span> <span class="o">(</span><span class="nc">CheckedSignUpMember</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"이미 존재하는 회원입니다."</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span>
          <span class="nc">Member</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">username</span><span class="o">(</span><span class="n">username</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">password</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
    
      <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genRefreshToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
      <span class="n">member</span><span class="o">.</span><span class="na">setRefreshToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">getMember</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// 토큰 유효성 검증</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// 토큰갱신</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">refreshAccessToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">refreshToken</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByRefreshToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">)</span>
          <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"유효하지 않은 토큰입니다."</span><span class="o">));</span>
    
      <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genAccessToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"토큰 갱신에 성공하였습니다."</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// 토큰으로 User 정보 가져오기</span>
    <span class="kd">public</span> <span class="nc">SecurityUser</span> <span class="nf">getUserFromAccessToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">accessToken</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">payloadBody</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">getClaims</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
      <span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">payloadBody</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">payloadBody</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">SecurityUser</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">Member</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.member.member.entity</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonIgnore</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.jpa.BaseEntity</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.persistence.Column</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.persistence.Entity</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.Getter</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.Setter</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.experimental.SuperBuilder</span><span class="o">;</span>
    
  <span class="nd">@Entity</span>
  <span class="nd">@Setter</span>
  <span class="nd">@Getter</span>
  <span class="nd">@AllArgsConstructor</span>
  <span class="nd">@NoArgsConstructor</span>
  <span class="nd">@SuperBuilder</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="kd">extends</span> <span class="nc">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="nd">@JsonIgnore</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="nd">@JsonIgnore</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">refreshToken</span><span class="o">;</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">MemberRepository</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.member.member.repository</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.entity.Member</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
    
  <span class="nd">@Repository</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Member</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>
    
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByRefreshToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">refreshToken</span><span class="o">);</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">MemberDto</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.member.member.dto</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.entity.Member</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.Getter</span><span class="o">;</span>
    
  <span class="nd">@Getter</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberDto</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">MemberDto</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="na">getUsername</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">MemberRequest</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.member.member.dto</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
    
  <span class="nd">@Data</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRequest</span> <span class="o">{</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    
  <span class="o">}</span>
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">JwtProvider</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.global.jwt</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.entity.Member</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.util.Ut</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">io.jsonwebtoken.Jwts</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">io.jsonwebtoken.SignatureAlgorithm</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">io.jsonwebtoken.security.Keys</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">javax.crypto.SecretKey</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
    
  <span class="nd">@Component</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtProvider</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.jwt.secretKey}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">secretKeyOrigin</span><span class="o">;</span>
    
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.accessToken.expirationSeconds}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">accessTokenExpirationSeconds</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="nc">SecretKey</span> <span class="n">cachedSecretKey</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nc">SecretKey</span> <span class="nf">getSecretKey</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">cachedSecretKey</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cachedSecretKey</span> <span class="o">=</span> <span class="n">_getSecretKey</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">cachedSecretKey</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">SecretKey</span> <span class="nf">_getSecretKey</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">keyBase64Encoded</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">secretKeyOrigin</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
      <span class="k">return</span> <span class="nc">Keys</span><span class="o">.</span><span class="na">hmacShaKeyFor</span><span class="o">(</span><span class="n">keyBase64Encoded</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">genAccessToken</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">genToken</span><span class="o">(</span><span class="n">member</span><span class="o">,</span> <span class="n">accessTokenExpirationSeconds</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">genRefreshToken</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">genToken</span><span class="o">(</span><span class="n">member</span><span class="o">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">genToken</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    
      <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
      <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
      <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
      <span class="nc">Date</span> <span class="n">accessTokenExpiresIn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">now</span> <span class="o">+</span> <span class="mi">1000L</span> <span class="o">*</span> <span class="n">seconds</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">claim</span><span class="o">(</span><span class="s">"body"</span><span class="o">,</span> <span class="nc">Ut</span><span class="o">.</span><span class="na">json</span><span class="o">.</span><span class="na">toStr</span><span class="o">(</span><span class="n">claims</span><span class="o">)).</span><span class="na">setExpiration</span><span class="o">(</span><span class="n">accessTokenExpiresIn</span><span class="o">)</span>
          <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">getSecretKey</span><span class="o">(),</span> <span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS512</span><span class="o">).</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="c1">// 클레임 정보 받아오기</span>
    <span class="kd">public</span> <span class="nc">Map</span> <span class="nf">getClaims</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">body</span> <span class="o">=</span>
          <span class="nc">Jwts</span><span class="o">.</span><span class="na">parserBuilder</span><span class="o">().</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">getSecretKey</span><span class="o">()).</span><span class="na">build</span><span class="o">().</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">).</span><span class="na">getBody</span><span class="o">()</span>
              <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"body"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">Ut</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// 유효성 검증</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">verify</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Jwts</span><span class="o">.</span><span class="na">parserBuilder</span><span class="o">().</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">getSecretKey</span><span class="o">()).</span><span class="na">build</span><span class="o">().</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">SecurityConfig</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.global.security</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.crypto.password.PasswordEncoder</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.web.SecurityFilterChain</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.web.util.matcher.AntPathRequestMatcher</span><span class="o">;</span>
    
  <span class="nd">@Configuration</span>
  <span class="nd">@EnableWebSecurity</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="n">csrf</span> <span class="o">-&gt;</span> <span class="n">csrf</span><span class="o">.</span><span class="na">disable</span><span class="o">()).</span><span class="na">authorizeHttpRequests</span><span class="o">(</span>
          <span class="o">(</span><span class="n">authorizeHttpRequests</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">authorizeHttpRequests</span><span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span>
              <span class="k">new</span> <span class="nf">AntPathRequestMatcher</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)).</span><span class="na">permitAll</span><span class="o">());</span>
      <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">ApiSecurityConfig</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.global.security</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.http.HttpMethod</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.config.http.SessionCreationPolicy</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.web.SecurityFilterChain</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span><span class="o">;</span>
    
  <span class="nd">@Configuration</span>
  <span class="nd">@EnableWebSecurity</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiSecurityConfig</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtAuthorizationFilter</span> <span class="n">jwtAuthorizationFilter</span><span class="o">;</span>
    
    <span class="nd">@Bean</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">apiFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    
      <span class="n">http</span><span class="o">.</span><span class="na">securityMatcher</span><span class="o">(</span><span class="s">"/api/**"</span><span class="o">).</span><span class="na">authorizeHttpRequests</span><span class="o">(</span>
              <span class="n">authorizeRequests</span> <span class="o">-&gt;</span> <span class="n">authorizeRequests</span><span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/articles"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">permitAll</span><span class="o">().</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/articles/*"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="s">"/api/*/members/login"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// 로그인은 누구나 가능, post 요청만 허용</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/members/logout"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// 로그인은 누구나 가능, post 요청만 허용</span>
                  <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()).</span><span class="na">csrf</span><span class="o">(</span><span class="n">csrf</span> <span class="o">-&gt;</span> <span class="n">csrf</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// csrf 토큰 끄기</span>
          <span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">httpBasic</span> <span class="o">-&gt;</span> <span class="n">httpBasic</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// httpBasic 로그인 방식 끄기</span>
          <span class="o">.</span><span class="na">formLogin</span><span class="o">(</span><span class="n">formLogin</span> <span class="o">-&gt;</span> <span class="n">formLogin</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// 폼 로그인 방식 끄기</span>
          <span class="o">.</span><span class="na">sessionManagement</span><span class="o">(</span><span class="n">sessionManagement</span> <span class="o">-&gt;</span> <span class="n">sessionManagement</span><span class="o">.</span><span class="na">sessionCreationPolicy</span><span class="o">(</span>
              <span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">))</span>
          <span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">jwtAuthorizationFilter</span><span class="o">,</span> <span class="c1">//엑세스 토큰을 이용한 로그인 처리</span>
              <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">JwtAuthorizationFilter</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.global.security</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.domain.member.member.service.MemberService</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">com.ll.chatApp.global.rsData.RsData</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.servlet.FilterChain</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.servlet.http.Cookie</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.servlet.http.HttpServletRequest</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">jakarta.servlet.http.HttpServletResponse</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.RequiredArgsConstructor</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.SneakyThrows</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.http.ResponseCookie</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.web.filter.OncePerRequestFilter</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
    
  <span class="nd">@Component</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthorizationFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="nd">@SneakyThrows</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
        <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/members/login"</span><span class="o">)</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()</span>
          <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/members/logout"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">_getCookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">);</span>
      <span class="c1">// accessToken 검증 or refreshToken 발급</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">accessToken</span><span class="o">.</span><span class="na">isBlank</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// 토큰 유효기간 검증</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">memberService</span><span class="o">.</span><span class="na">validateToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">))</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">_getCookie</span><span class="o">(</span><span class="s">"refreshToken"</span><span class="o">);</span>
          <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">refreshAccessToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">);</span>
          <span class="n">_addHeaderCookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="n">rs</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="c1">// securityUser 가져오기</span>
        <span class="nc">SecurityUser</span> <span class="n">securityUser</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getUserFromAccessToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
        <span class="c1">// 인가 처리</span>
        <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">securityUser</span><span class="o">.</span><span class="na">genAuthentication</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">_getCookie</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
      <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">cookies</span><span class="o">).</span><span class="na">filter</span><span class="o">(</span><span class="n">cookie</span> <span class="o">-&gt;</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">)).</span><span class="na">findFirst</span><span class="o">()</span>
          <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cookie:</span><span class="o">:</span><span class="n">getValue</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">_addHeaderCookie</span><span class="o">(</span><span class="nc">String</span> <span class="n">tokenName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ResponseCookie</span> <span class="n">cookie</span> <span class="o">=</span>
          <span class="nc">ResponseCookie</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">tokenName</span><span class="o">,</span> <span class="n">token</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">sameSite</span><span class="o">(</span><span class="s">"None"</span><span class="o">).</span><span class="na">secure</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">httpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
      <span class="n">resp</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Set-Cookie"</span><span class="o">,</span> <span class="n">cookie</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">SecurityUser</span></p><details> <summary><code class="code">코드 보기</code></summary><div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.global.security</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">lombok.Getter</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.core.Authentication</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.User</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
    
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityUser</span> <span class="kd">extends</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">SecurityUser</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span>
        <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">genAuthentication</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Authentication</span> <span class="n">auth</span> <span class="o">=</span>
          <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
      <span class="k">return</span> <span class="n">auth</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div></div></details></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-스프링-시큐리티-도입-초기-권한설정"><span class="me-2">🔆 스프링 시큐리티 도입, 초기 권한설정</span><a href="#-스프링-시큐리티-도입-초기-권한설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="red">Spring Security 의존성</span> 추가<ul><li><p><span class="settingpath">build.gradle</span></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  implementation 'org.springframework.boot:spring-boot-starter-security'
</pre></table></code></div></div></ul></ul><p><br /></p><p><br /></p><ul><li><p>설정하면 자동으로 <span class="blue">기본 로그인 화면</span>이 추가된다.</p><p><a href="/assets/img/posts/springboot-security/image.png" class="popup img-link left shimmer"><img src="/assets/img/posts/springboot-security/image.png" alt="" width="300" height="150" loading="lazy"></a></p><div class="clear"></div><ul><li>기존의 로그인을 요청한다면 <span class="error">401 Unauthorized</span> 에러 발생   ⇒   <span class="red">정상</span></ul></ul><p><br /></p><p><br /></p><ul><li><span class="pink">Security 설정</span>을 위한 <span class="pink">클래스</span> 생성<ul><li><p><span class="path">SecurityConfig</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>  <span class="nd">@Configuration</span>
  <span class="nd">@EnableWebSecurity</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="o">{</span>
        
    <span class="nd">@Bean</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">filterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="n">http</span>
          <span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="n">csrf</span> <span class="o">-&gt;</span> <span class="n">csrf</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span>
          <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">((</span><span class="n">authorizeHttpRequests</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">authorizeHttpRequests</span>
              <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="k">new</span> <span class="nc">AntPathRequestMatcher</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)).</span><span class="na">permitAll</span><span class="o">())</span>
          <span class="o">;</span>
      <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
        
    <span class="nd">@Bean</span>
    <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div><ul><li><strong><code class="language-plaintext highlighter-rouge">.csrf(csrf -&gt; csrf.disable())</code></strong><ul><li><span class="blue">csrf 토큰 인증</span> 끄기<li><code class="language-plaintext highlighter-rouge">csrf(AbstractHttpConfigurer::disable)</code>는 결과는 같지만 <span class="red">람다</span>를 사용하여 간단히 표현한 것</ul><li><strong><code class="language-plaintext highlighter-rouge">.authorizeHttpRequests((authorizeHttpRequests) -&gt; authorizeHttpRequests.requestMatchers(new AntPathRequestMatcher("/**")).permitAll())</code></strong><ul><li><code class="language-plaintext highlighter-rouge">.authorizeHttpRequests(*auth* -&gt; *auth*.anyRequest().permitAll())</code><li>두 코드는 동일하다.</ul><li><strong><code class="language-plaintext highlighter-rouge">("/**")</code></strong><ul><li>모든 <span class="red">End Point</span>를 뜻한다.</ul><li><strong><code class="language-plaintext highlighter-rouge">permitAll()</code></strong><ul><li>모두 허용</ul><li><strong><code class="language-plaintext highlighter-rouge">passwordEncoder()</code></strong>는 <span class="pink">비밀번호 인코딩</span>하려고 등록한 <span class="green">팩토리 메서드</span>이다.<li><strong><code class="language-plaintext highlighter-rouge">@EnableWebSecurity</code></strong><ul><li>Spring Security의 <span class="red">기본 설정</span>을 <span class="line">비활성화</span>하고, 개발자가 제공한 커스텀 설정(<code class="language-plaintext highlighter-rouge">SecurityFilterChain</code> 등)을 적용하도록 Spring Security 환경을 구성하는 것<li>없어도 Spring Boot 2.7 이상과 <span class="red">Spring Security 5.7 이상 버전</span>에서는 <code class="language-plaintext highlighter-rouge">SecurityFilterChain</code>를 정의하고 <span class="red">Bean</span>으로 등록하면 <span class="red line">자동 인식</span>한다.</ul></ul></ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-회원가입-구현"><span class="me-2">🔆 회원가입 구현</span><a href="#-회원가입-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><span class="path">ApiV1MemberController</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>  <span class="nd">@RestController</span>
  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/v1/members"</span><span class="o">)</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiV1MemberController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtProvider</span> <span class="n">jwtProvider</span><span class="o">;</span>
    
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/signup"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="nf">signup</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">memberRequest</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"회원가입에 성공하였습니다."</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MemberDto</span><span class="o">(</span><span class="n">member</span><span class="o">));</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li>회원 가입용 <span class="red">Request DTO</span>를 사용하고 <code class="language-plaintext highlighter-rouge">@Valid</code>로 검증한다.</ul></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">MemberService</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>  <span class="nd">@Service</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberRepository</span> <span class="n">memberRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtProvider</span> <span class="n">jwtProvider</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nc">Member</span> <span class="nf">join</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="nc">CheckedSignUpMember</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    
      <span class="k">if</span> <span class="o">(</span><span class="nc">CheckedSignUpMember</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"이미 존재하는 회원입니다."</span><span class="o">);</span>
      <span class="o">}</span>
    
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span>
          <span class="nc">Member</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">username</span><span class="o">(</span><span class="n">username</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">password</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
    
      <span class="k">return</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    <span class="o">}</span>
    
</pre></table></code></div></div><ul><li>기존 DB에서 <span class="blue">회원 가입 전</span> <span class="pink">존재 여부를 파악</span>한다.</ul></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">MemberRequest</span> 생성</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>  <span class="kn">package</span> <span class="nn">com.ll.chatApp.domain.member.member.dto</span><span class="o">;</span>
    
  <span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
    
  <span class="nd">@Data</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRequest</span> <span class="o">{</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
  <span class="o">}</span>
</pre></table></code></div></div><ul><li>DTO 클래스</ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-rsdata-클래스-수정"><span class="me-2">🔆 RsData 클래스 수정</span><a href="#-rsdata-클래스-수정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><span class="path">RsData</span></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>  @JsonInclude(JsonInclude.Include.NON_NULL)
  @AllArgsConstructor
  @Getter
  public class RsData&lt;T&gt; {
      private String resultCode;
      private String msg;
      private T data;
    
      public RsData(String resultCode, String msg) {
          this(resultCode, msg, null);
      }
    
      @JsonIgnore
      public int getStatusCode() {
          return Integer.parseInt(resultCode.split("-")[0]);
      }
  }
    
</pre></table></code></div></div></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-jwt-토큰-발급을-위한-작업"><span class="me-2">🔆 JWT 토큰 발급을 위한 작업</span><a href="#-jwt-토큰-발급을-위한-작업" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="blue">JWT 관련 의존성</span> 추가하기<ul><li><p><span class="settingpath">build.gradle</span></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
  runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
  runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'
</pre></table></code></div></div></ul></ul><p><br /></p><p><br /></p><ul><li><span class="pink">JWT Secret 키</span> 및 <span class="blue">AccessToken 유효 시간</span>을 <span class="red line">환경변수</span>로 설정하기<ul><li><p><span class="settingpath">application-secret.yml</span></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>  custom:
    jwt:
      secretKey: 12314124124dfsdf9sdfa8f89asd8f9sdaf8t238f9safsdf98sadfsdafasd2342dsgrer2
    accessToken:
      expirationSeconds: "#{60 * 10}"
</pre></table></code></div></div><ul><li>나중에 이렇게 설정한 정보로 <span class="class">JwtProvider</span>로 값을 꺼내서 사용한다.</ul></ul></ul><p><br /></p><p><br /></p><ul><li><span class="path">Ut.java</span><ul><li><span class="line">JwtProvider</span>에서 <span class="red">토큰</span> 생성 시 Map으로 만든 <code class="language-plaintext highlighter-rouge">claims</code> 데이터를 <span class="back">json으로 전환</span>한다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>  public class Ut {
      public static class json {
          public static Object toStr(Map&lt;String, Object&gt; map) {
              try {
                  return new ObjectMapper().writeValueAsString(map);
              } catch (JsonProcessingException e) {
                  return null;
              }
          }
      }
      public static Map&lt;String, Object&gt; toMap(String jsonStr) {
          try {
              return new ObjectMapper().readValue(jsonStr, LinkedHashMap.class);
          } catch (JsonProcessingException e) {
              return null;
          }
      }
  }
</pre></table></code></div></div></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">global/jwt/JwtProvider</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>  <span class="nd">@Component</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtProvider</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.jwt.secretKey}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">secretKeyOrigin</span><span class="o">;</span>
    
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.accessToken.expirationSeconds}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">accessTokenExpirationSeconds</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="nc">SecretKey</span> <span class="n">cachedSecretKey</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nc">SecretKey</span> <span class="nf">getSecretKey</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">cachedSecretKey</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cachedSecretKey</span> <span class="o">=</span> <span class="n">_getSecretKey</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">cachedSecretKey</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li><span class="setting">application-secret.yml</span>에서 설정한 <code class="language-plaintext highlighter-rouge">secretKey</code>와 <code class="language-plaintext highlighter-rouge">expirationSeconds</code>를 <strong><code class="language-plaintext highlighter-rouge">@Value</code></strong> 애노테이션으로 가져와서 필드에 주입한다.<li><p><strong><code class="language-plaintext highlighter-rouge">cachedSecretKey</code></strong>는 <code class="language-plaintext highlighter-rouge">secretKey</code>로 부터 생성된 <span class="class">SecretKey</span> 객체이다.</p><p>즉 SecretKey를 생성하는 작업은 상대적으로 Base64 인코딩 및 HMAC 키 생성으로 비용이 높은 작업이다.</p><p>따라서 <span class="red">캐싱</span>과 <span class="blue">싱글톤 패턴</span>을 사용하여 비용을 줄인다.</p><li><span class="greenback">캐싱   (Caching)</span><ul><li>데이터를 빠르게 접근하기 위해 <span class="purple">메모리에 임시로 저장</span>하는 기술</ul><li><strong><code class="language-plaintext highlighter-rouge">getSecretKey()</code></strong>는 <span class="red">캐싱</span>과 <span class="blue">싱글톤 패턴</span>을 통해 반복적으로 동일한 키를 생성하지 않고, 이미 생성된 객체를 재사용하기 위한 메서드이다.</ul><p><br /></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>    <span class="kd">private</span> <span class="nc">SecretKey</span> <span class="nf">_getSecretKey</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">keyBase64Encoded</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">secretKeyOrigin</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
      <span class="k">return</span> <span class="nc">Keys</span><span class="o">.</span><span class="na">hmacShaKeyFor</span><span class="o">(</span><span class="n">keyBase64Encoded</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">genAccessToken</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">genToken</span><span class="o">(</span><span class="n">member</span><span class="o">,</span> <span class="n">accessTokenExpirationSeconds</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">genRefreshToken</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">genToken</span><span class="o">(</span><span class="n">member</span><span class="o">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">genToken</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">,</span> <span class="kt">int</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    
      <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
      <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">member</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
      <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
      <span class="nc">Date</span> <span class="n">accessTokenExpiresIn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">now</span> <span class="o">+</span> <span class="mi">1000L</span> <span class="o">*</span> <span class="n">seconds</span><span class="o">);</span>
      <span class="k">return</span> <span class="nc">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">claim</span><span class="o">(</span><span class="s">"body"</span><span class="o">,</span> <span class="nc">Ut</span><span class="o">.</span><span class="na">json</span><span class="o">.</span><span class="na">toStr</span><span class="o">(</span><span class="n">claims</span><span class="o">)).</span><span class="na">setExpiration</span><span class="o">(</span><span class="n">accessTokenExpiresIn</span><span class="o">)</span>
          <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">getSecretKey</span><span class="o">(),</span> <span class="nc">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS512</span><span class="o">).</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li>메서드명 앞에 <code class="language-plaintext highlighter-rouge">_</code>를 붙이는 것은 해당 클래스 내부에서만 활용하는 <span class="blue">private 메서드</span>를 <span class="blue">표시</span>하기 위한 것이다.<li><strong><code class="language-plaintext highlighter-rouge">_getSecretKey()</code></strong><ul><li>설정 파일에서 설정한 <code class="language-plaintext highlighter-rouge">secretKey</code>를 <span class="red">Base64</span>로 인코딩 한 후 <span class="red">HMAC</span>으로 <span class="class">SecretKey</span> 객체를 생성하는 것</ul><li><strong><code class="language-plaintext highlighter-rouge">genToken()</code></strong>은 <strong><code class="language-plaintext highlighter-rouge">genAccessToken()</code></strong>과 <strong><code class="language-plaintext highlighter-rouge">genToken()</code></strong>의 <span class="line">공통 코드를 분리</span>한 메서드이다.<ul><li><span class="blueline">사용자 정보</span>로부터 <span class="red">Token</span>을 만든다.<li><span class="green">만료 시간</span>을 받아서 설정할 수 있도록 한다.<li><code class="language-plaintext highlighter-rouge">claims</code>라는 Map을 만들어 <span class="blueline">사용자 정보</span>를 저장한다.<li><code class="language-plaintext highlighter-rouge">claims</code>와 parsing에 사용할 <span class="class">Ut</span> 클래스와 함께 넘겨서 <span class="red">JWT 토큰</span>을 생성하고 <span class="pink">token 문자열</span>을 리턴한다.</ul></ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-apisecurityconfig"><span class="me-2">🔆 ApiSecurityConfig</span><a href="#-apisecurityconfig" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="red line">API</span>와 관련된 처리를 할 Config 설정<li><span class="class">SecurityConfig</span> 설정의 <span class="blue">우선 순위</span>는 <span class="red line">작은 범위</span>가 <span class="red">먼저</span>이다. ⭐<ul><li><p><span class="path">ApiSecurityConfig</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre>  <span class="nd">@Configuration</span>
  <span class="nd">@EnableWebSecurity</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiSecurityConfig</span> <span class="o">{</span>
        
    <span class="nd">@Bean</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">apiFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="n">http</span>
          <span class="o">.</span><span class="na">securityMatcher</span><span class="o">(</span><span class="s">"/api/**"</span><span class="o">)</span>
          <span class="o">.</span><span class="na">authorizeHttpRequests</span><span class="o">(</span>
              <span class="n">authorizeRequests</span> <span class="o">-&gt;</span> <span class="n">authorizeRequests</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/articles"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/articles/*"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="s">"/api/*/members/login"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// 로그인은 누구나 가능, post 요청만 허용</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/members/logout"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
          <span class="o">)</span>
          <span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="n">csrf</span> <span class="o">-&gt;</span> <span class="n">csrf</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// csrf 토큰 끄기</span>
          <span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">httpBasic</span> <span class="o">-&gt;</span> <span class="n">httpBasic</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// httpBasic 로그인 방식 끄기</span>
          <span class="o">.</span><span class="na">formLogin</span><span class="o">(</span><span class="n">formLogin</span> <span class="o">-&gt;</span> <span class="n">formLogin</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// 폼 로그인 방식 끄기</span>
          <span class="o">.</span><span class="na">sessionManagement</span><span class="o">(</span>
              <span class="n">sessionManagement</span> <span class="o">-&gt;</span> <span class="n">sessionManagement</span><span class="o">.</span><span class="na">sessionCreationPolicy</span><span class="o">(</span>
              <span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">)</span>
          <span class="o">);</span>
                
      <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
        
</pre></table></code></div></div><ul><li><strong><code class="language-plaintext highlighter-rouge">.securityMatcher("/api/**")</code></strong><ul><li><span class="red">설정한 URL 요청</span>이 들어오면 <span class="line">아래의 설정을 따르겠다</span>는 말이다.</ul><li><strong><code class="language-plaintext highlighter-rouge">.requestMatchers(HttpMethod.GET, "/api/*/articles").permitAll()</code></strong><ul><li><strong><code class="language-plaintext highlighter-rouge">/api/*/</code></strong>   :   <code class="language-plaintext highlighter-rouge">/api/v1</code>, <code class="language-plaintext highlighter-rouge">/api/v2</code> .. 등 모두를 의미한다.<li><span class="pinkback">즉, 목록 조회를 인증/인가 없이 허용하겠다는 의미이다.</span></ul><li><strong><code class="language-plaintext highlighter-rouge">requestMatchers(HttpMethod.GET, "/api/*/articles/*").permitAll()</code></strong><ul><li><span class="pinkback">상세 조회를 인증/인가 없이 허용하겠다는 의미이다.</span></ul><li><strong><code class="language-plaintext highlighter-rouge">.httpBasic(httpBasic -&gt; httpBasic.disable())</code></strong><ul><li>httpBasic 로그인 방식 끄기   ⇒   <span class="pink">기본 로그인 사용 안 함</span></ul><li><strong><code class="language-plaintext highlighter-rouge">.formLogin(formLogin -&gt; formLogin.disable())</code></strong><ul><li>폼 로그인 방식 끄기</ul><li><strong><code class="language-plaintext highlighter-rouge">.sessionManagement(sessionManagement -&gt; sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))</code></strong><ul><li>세션 방식 끄기   (<code class="language-plaintext highlighter-rouge">SessionCreationPolicy.STATELESS</code>)</ul></ul></ul></ul><p><br /></p><ul><li><span class="green line">허용 되지 않는 End Point</span> 요청 시   ⇒   <span class="error">403 에러</span>   (권한 없음)</ul><p><br /> <br /> <br /> <br /></p><h2 id="3-로그인-구현"><span class="me-2">3. 로그인 구현</span><a href="#3-로그인-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="-jwt-accesstoken-발급-확인-테스트"><span class="me-2">🔆 JWT AccessToken 발급 확인 테스트</span><a href="#-jwt-accesstoken-발급-확인-테스트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><span class="path">ApiV1MemberController</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getMember</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    
      <span class="c1">// 토큰 생성</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genAccessToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"로그인에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">String token = jwtProvider.genAccessToken(member);</code><ul><li><span class="green">회원 정보</span>를 넘기며 <span class="red">AcessToken</span>을 생성한다.</ul></ul></ul><p><br /> <br /> <br /></p><h3 id="-jwt-accesstoken-발급-쿠키에-담아-보내기"><span class="me-2">🔆 JWT AccessToken 발급 쿠키에 담아 보내기</span><a href="#-jwt-accesstoken-발급-쿠키에-담아-보내기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="red line">쿠키</span>는 Spring에서 제공하는 <span class="class">HttpServletResponse</span> 객체를 이용한다.<ul><li>해당 객체에게 <strong><code class="language-plaintext highlighter-rouge">addCookie()</code></strong>를 호출하고 <code class="language-plaintext highlighter-rouge">new Cookie()</code>로 객체를 만들어 넘긴다.</ul></ul><p><br /></p><ul><li><p><span class="path">ApiV1MemberController</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">,</span>
        <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getMember</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    
      <span class="c1">// 토큰 생성</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genAccessToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    
      <span class="c1">// 응답 데이터에 accessToken 이름으로 토큰을 발급</span>
      <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setSecure</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"로그인에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li><p><strong><code class="language-plaintext highlighter-rouge">setPath()</code></strong>로 <span class="blue">사용 가능한 경로</span>를 설정하지 않는다면 <span class="red">특정 경로</span>에서 쿠키를 사용할 수 없을 수도 있다.</p><li><p>브라우저의 개발자 도구에서 <span class="pink">쿠키</span>를 확인할 수 있다.</p><p><a href="/assets/img/posts/springboot-security/image 1.png" class="popup img-link left shimmer"><img src="/assets/img/posts/springboot-security/image 1.png" alt="" width="500" height="200" loading="lazy"></a></p><div class="clear"></div></ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-쿠키에-담긴-토큰을-이용해-내-회원정보-불러오기"><span class="me-2">🔆 쿠키에 담긴 토큰을 이용해 내 회원정보 불러오기</span><a href="#-쿠키에-담긴-토큰을-이용해-내-회원정보-불러오기" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="path">JwtProvider</span><ul><li><span class="red">클레임 정보 받아오는 메서드</span> 추가<ul><li>토큰을 <span class="red">복호화</span>하여 <span class="back">Body 안의 데이터(json)</span>를 <span class="blue">Map</span>으로 다시 바꿔준다.</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>      public Map getClaims(String token) {
          String body = Jwts.parserBuilder()
              .setSigningKey(getSecretKey()).build()
              .parseClaimsJws(token).getBody()
              .get("body", String.class);
          return Ut.toMap(body);
      }
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">Jwts.parserBuilder()</code>는 <span class="red">JWT 토큰</span>을 파싱하는 용도이다.<li>token의 body 안의 <strong><code class="language-plaintext highlighter-rouge">claims</code></strong> 정보를 가지고 오기 위한 것이다.</ul></ul></ul><p><br /></p><p><br /></p><ul><li><span class="path">ApiV1MemberController</span><ul><li><p><span class="red">Cookie</span>에서 토큰을 가져와서 <span class="blueline">내 정보를 읽어오는 메서드</span> 생성</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/me"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">MemberDto</span><span class="o">&gt;</span> <span class="nf">me</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
      <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        
      <span class="k">for</span> <span class="o">(</span><span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">accessToken</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
        
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">getClaims</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
        
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">memberService</span><span class="o">.</span><span class="na">getMember</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        
      <span class="k">return</span> <span class="k">new</span> <span class="nf">RsData</span><span class="o">(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"회원정보 조회 성공"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MemberDto</span><span class="o">(</span><span class="n">member</span><span class="o">));</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li><p>그러나 <span class="green">Token을 쿠키에 담을 때</span> 쿠키에 <strong><code class="language-plaintext highlighter-rouge">setPath("/")</code></strong>를 <span class="line">명시적으로 설정하지 않으면</span>,</p><p><span class="pinkback">기본적으로 쿠키의 경로는 쿠키가 생성된 요청 경로로 설정된다</span> ⭐</p><p>(메서드의 경로가 <code class="language-plaintext highlighter-rouge">api/v1/auth/me</code>인 경우 <code class="language-plaintext highlighter-rouge">/auth</code>로 경로가 설정된다.)</p><ul><li><span class="red line">설정된 경로 하위 경로</span>까지 <span class="back">쿠키가 유효</span>하다 ⭐`</ul></ul></ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-httponly-cookie로-변경"><span class="me-2">🔆 HttpOnly Cookie로 변경</span><a href="#-httponly-cookie로-변경" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>일반 쿠키를 사용하면 <span class="purple">사용자가 임의로 처리</span>할 수 있다. 즉 탈취의 위험성이 있다.<ul><li>따라서, <span class="purple">보안 설정이 적용된 쿠키</span>인 <span class="blueline">HttpOnly Cookie</span>를 사용한다.</ul><li><p><span class="path">ApiV1MemberController</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">,</span>
        <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getMember</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    
      <span class="c1">// 토큰 생성</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genAccessToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    
      <span class="c1">// 응답 데이터에 accessToken 이름으로 토큰을 발급</span>
      <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setSecure</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"로그인에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div></ul><p><br /> <br /> <br /> <br /></p><h2 id="4-jwt-인가-처리"><span class="me-2">4. JWT 인가 처리</span><a href="#4-jwt-인가-처리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="-jwt-토큰-인가-처리"><span class="me-2">🔆 JWT 토큰 인가 처리</span><a href="#-jwt-토큰-인가-처리" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="path">Member</span><ul><li><span class="purple">refresh 토큰 필드</span> 추가</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>  <span class="nd">@Entity</span>
  <span class="nd">@Setter</span>
  <span class="nd">@Getter</span>
  <span class="nd">@AllArgsConstructor</span>
  <span class="nd">@NoArgsConstructor</span>
  <span class="nd">@SuperBuilder</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="kd">extends</span> <span class="nc">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="nd">@JsonIgnore</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="nd">@JsonIgnore</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">refreshToken</span><span class="o">;</span>
  <span class="o">}</span>
</pre></table></code></div></div><ul><li>DB에 <span class="blueline">refreshToken</span>을 저장하여 <span class="pink">클라이언트</span>가 보유한 <span class="blueline">refresh Token</span>과 비교하여 <span class="red">검증</span>한다.<li>방법 중 하나는 아래와 같다.</ul></ul><p><br /></p><ul><li><span class="path">MemberRepository</span><ul><li><p><span class="pink">refresh 토큰으로 해당 사용자를 찾는 메서드</span> 추가</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>  <span class="nd">@Repository</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Member</span> <span class="nf">findByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>
        
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">findByRefreshToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">refreshToken</span><span class="o">);</span>
  <span class="o">}</span>
</pre></table></code></div></div></ul></ul><p><br /></p><ul><li><p><span class="path">MemberService</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>    <span class="c1">// 토큰 유효성 검증</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validateToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// 토큰갱신</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">refreshAccessToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">refreshToken</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">findByRefreshToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">)</span>
          <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="s">"유효하지 않은 토큰입니다."</span><span class="o">));</span>
    
      <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genAccessToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"토큰 갱신에 성공하였습니다."</span><span class="o">,</span> <span class="n">accessToken</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// 토큰으로 User 정보 가져오기</span>
    <span class="kd">public</span> <span class="nc">SecurityUser</span> <span class="nf">getUserFromAccessToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">accessToken</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">payloadBody</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">getClaims</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
      <span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">payloadBody</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">payloadBody</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">SecurityUser</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li>토큰 유효성 검증   (<code class="language-plaintext highlighter-rouge">validateToken(String token)</code>)<li>토큰 갱신   (<span class="purple">refresh 토큰</span>으로 <span class="red">새로운 accessToken</span> 생성)<ul><li><code class="language-plaintext highlighter-rouge">refreshAccessToken(String refreshToken)</code></ul><li>토큰으로 <span class="pink">User 정보</span> 가져오기   (<code class="language-plaintext highlighter-rouge">getUserFromAccessToken(String accessToken)</code>)</ul></ul><p><br /></p><p><br /></p><ul><li><span class="path">SecurityUser</span><ul><li><span class="red">Security의 User 클래스</span>를 <span class="blue">상속</span>받아서 처리한다.<li>생성자로 데이터를 받아서 <span class="red">Security의 User 클래스</span> 한 번 더 <span class="blue">가공하여 리턴</span>하는 용도</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityUser</span> <span class="kd">extends</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">SecurityUser</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span>
        <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">genAuthentication</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Authentication</span> <span class="n">auth</span> <span class="o">=</span>
          <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
      <span class="k">return</span> <span class="n">auth</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div><ul><li><span class="class">SecurityUser</span> 객체를 만들 때 <span class="purple">생성자</span>로 정보를 받아서 설정한다.<li><strong><code class="language-plaintext highlighter-rouge">genAuthentication()</code></strong><ul><li><span class="class">Authentication</span> 클래스는 Spring Security에서 제공하는 <span class="red">인터페이스</span><li>이 메서드는 <span class="class">Authentication</span> 구현체인 <span class="instance">UsernamePasswordAuthenticationToken</span> 객체를 반환하는 메서드이다.<li><span class="instance">Security User</span> 객체의 비밀번호와, 권한으로 <span class="instance">UsernamePasswordAuthenticationToken</span> 객체를 생성한다.<li>즉, <span class="pinkback">인증된 객체를 만드는 것</span>이다.</ul></ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-jwtauthorizationfilter-"><span class="me-2">🔆 JwtAuthorizationFilter ⭐</span><a href="#-jwtauthorizationfilter-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><span class="path">JwtAuthorizationFilter</span><ul><li><span class="line">JWT 인가 처리</span>를 위한 클래스이다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre>  <span class="nd">@Component</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthorizationFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MemberService</span> <span class="n">memberService</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="nd">@SneakyThrows</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
        <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/members/login"</span><span class="o">)</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()</span>
          <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/members/logout"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">_getCookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">);</span>
      <span class="c1">// accessToken 검증 or refreshToken 발급</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">accessToken</span><span class="o">.</span><span class="na">isBlank</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// 토큰 유효기간 검증</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">memberService</span><span class="o">.</span><span class="na">validateToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">))</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">_getCookie</span><span class="o">(</span><span class="s">"refreshToken"</span><span class="o">);</span>
          <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">refreshAccessToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">);</span>
          <span class="n">_addHeaderCookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="n">rs</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="c1">// securityUser 가져오기</span>
        <span class="nc">SecurityUser</span> <span class="n">securityUser</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getUserFromAccessToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
        <span class="c1">// 인가 처리</span>
        <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">securityUser</span><span class="o">.</span><span class="na">genAuthentication</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">_getCookie</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
      <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">cookies</span><span class="o">).</span><span class="na">filter</span><span class="o">(</span><span class="n">cookie</span> <span class="o">-&gt;</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">)).</span><span class="na">findFirst</span><span class="o">()</span>
          <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cookie:</span><span class="o">:</span><span class="n">getValue</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">_addHeaderCookie</span><span class="o">(</span><span class="nc">String</span> <span class="n">tokenName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ResponseCookie</span> <span class="n">cookie</span> <span class="o">=</span>
          <span class="nc">ResponseCookie</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">tokenName</span><span class="o">,</span> <span class="n">token</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">sameSite</span><span class="o">(</span><span class="s">"None"</span><span class="o">).</span><span class="na">secure</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">httpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
      <span class="n">resp</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Set-Cookie"</span><span class="o">,</span> <span class="n">cookie</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
    
</pre></table></code></div></div><ul><li>이 클래스는 <span class="blueline">JWT 토큰 인가</span>를 확인하는 클래스이다.<li>먼저 <span class="pinkback">인가 확인을 제외</span>할 <span class="red">URL</span>을 지정한다.<ul><li><p>즉, <span class="purple">로그인 또는 로그아웃 API URL</span>과 <span class="red">일치</span>하는 경우,</p><p><span class="red">필터 체인</span>에서 <span class="line">다음 필터로 요청을 전달</span>하고, 이후의 로직을 실행하지 않도록 return한다.</p></ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>      <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/members/login"</span><span class="o">)</span> <span class="o">||</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">()</span>
          <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/api/v1/members/logout"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
</pre></table></code></div></div></ul><p><br /></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>    <span class="nc">String</span> <span class="n">accessToken</span> <span class="o">=</span> <span class="n">_getCookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">);</span>
      <span class="c1">// accessToken 검증 or refreshToken 발급</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">accessToken</span><span class="o">.</span><span class="na">isBlank</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// 토큰 유효기간 검증</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">memberService</span><span class="o">.</span><span class="na">validateToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">))</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">_getCookie</span><span class="o">(</span><span class="s">"refreshToken"</span><span class="o">);</span>
          <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">refreshAccessToken</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">);</span>
          <span class="n">_addHeaderCookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="n">rs</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="c1">// securityUser 가져오기</span>
        <span class="nc">SecurityUser</span> <span class="n">securityUser</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getUserFromAccessToken</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
        <span class="c1">// 인가 처리</span>
        <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">securityUser</span><span class="o">.</span><span class="na">genAuthentication</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
      <span class="o">}</span>
</pre></table></code></div></div><ul><li><span class="instance">HttpServletRequest</span>에서 <span class="blue">Cookie 배열</span>을 읽어와서 <span class="pink">원하는 쿠키 이름의 쿠키</span>를 찾아 가져온다.<li><span class="pink">만약 쿠키가 있지만</span>, Token이 유효하지 않다면 <span class="green">refresh token</span>을 가져와서 <span class="green">refresh token</span>으로 새로운 <span class="pinkback">Access Token</span>을 발급 받고 <code class="language-plaintext highlighter-rouge">_addHeaderCookie()</code>로 <span class="blueline">응답 Header</span>의 쿠키에 다시 넣어준다.<li>또 <span class="pinkback">Access Token</span>으로 해당 <span class="class">Security User</span> 객체를 가져와서 <span class="red">인증 정보</span>로 <span class="class">SecurityContext</span>에 넣어준다.</ul></ul><p><br /></p><p><br /></p><ul><li><span class="path">ApiSecurityConfig</span> 수정하기<ul><li><code class="language-plaintext highlighter-rouge">JwtAuthorizationFilter</code> 필터를 추가하여 <span class="blue">AccessToken을 이용한 로그인</span>을 처리한다.</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>  <span class="nd">@Configuration</span>
  <span class="nd">@EnableWebSecurity</span>
  <span class="nd">@RequiredArgsConstructor</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiSecurityConfig</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JwtAuthorizationFilter</span> <span class="n">jwtAuthorizationFilter</span><span class="o">;</span>
    
    <span class="nd">@Bean</span>
    <span class="nc">SecurityFilterChain</span> <span class="nf">apiFilterChain</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    
      <span class="n">http</span><span class="o">.</span><span class="na">securityMatcher</span><span class="o">(</span><span class="s">"/api/**"</span><span class="o">).</span><span class="na">authorizeHttpRequests</span><span class="o">(</span>
              <span class="n">authorizeRequests</span> <span class="o">-&gt;</span> <span class="n">authorizeRequests</span><span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/articles"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">permitAll</span><span class="o">().</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/articles/*"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="s">"/api/*/members/login"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// 로그인은 누구나 가능, post 요청만 허용</span>
                  <span class="o">.</span><span class="na">requestMatchers</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">"/api/*/members/logout"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// 로그인은 누구나 가능, post 요청만 허용</span>
                  <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()).</span><span class="na">csrf</span><span class="o">(</span><span class="n">csrf</span> <span class="o">-&gt;</span> <span class="n">csrf</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// csrf 토큰 끄기</span>
          <span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">httpBasic</span> <span class="o">-&gt;</span> <span class="n">httpBasic</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// httpBasic 로그인 방식 끄기</span>
          <span class="o">.</span><span class="na">formLogin</span><span class="o">(</span><span class="n">formLogin</span> <span class="o">-&gt;</span> <span class="n">formLogin</span><span class="o">.</span><span class="na">disable</span><span class="o">())</span> <span class="c1">// 폼 로그인 방식 끄기</span>
          <span class="o">.</span><span class="na">sessionManagement</span><span class="o">(</span><span class="n">sessionManagement</span> <span class="o">-&gt;</span> <span class="n">sessionManagement</span><span class="o">.</span><span class="na">sessionCreationPolicy</span><span class="o">(</span>
              <span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">))</span>
          <span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span>
                  <span class="n">jwtAuthorizationFilter</span><span class="o">,</span> <span class="c1">//엑세스 토큰을 이용한 로그인 처리</span>
              <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></table></code></div></div><ul><li><span class="instance">jwtAuthorizationFilter</span> 필터를 <span class="instance">UsernamePasswordAuthenticationFilter</span> 보다 먼저 실행하도록 설정한다.<ul><li><code class="language-plaintext highlighter-rouge">.addFilterBefore(jwtAuthorizationFilter, UsernamePasswordAuthenticationFilter.class);</code></ul><li>이렇게 하면 <span class="red">모든 End Point 요청</span>이 먼저 <span class="instance">jwtAuthorizationFilter</span> 필터를 거쳐서 <span class="pink">토큰을 통해 접근을 허가</span> 받는다.<ul><li>이 때 특정 End Point(로그인, 로그아웃 등)은 제외 처리를 하여 검사하지 않도록 한다.</ul></ul></ul><p><br /></p><ul><li>위의 <span class="instance">jwtAuthorizationFilter</span> 필터를 거치지 않은 End Point 요청은 <span class="instance">UsernamePasswordAuthenticationFilter</span> 필터를 거치게 된다.<ul><li><span class="purple">필터 대상</span>   :   로그인, 로그아웃 등   (<span class="line">JWT 필터에서 제외 받은 End Point</span>)<li><p>다만 사전에 이 필터에 <span class="pink">지정된 End Point</span>는 <span class="line">모두 허용</span>시킨다.</p><p>즉, <span class="blue">로그인, 로그아웃</span>은 요청을 보내면 통과시킬 수 있다.</p></ul></ul><p><br /></p><p><br /></p><ul><li><p><span class="path">JwtProvider</span>에 <strong><code class="language-plaintext highlighter-rouge">verify()</code></strong> 메서드 추가하기</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>    
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">verify</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Jwts</span><span class="o">.</span><span class="na">parserBuilder</span><span class="o">().</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">getSecretKey</span><span class="o">()).</span><span class="na">build</span><span class="o">().</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li><span class="red">유효성 검증</span>을 위한 메서드이다.<li><span class="pink">JWT</span>의 <span class="pink">클레임(Claims)</span> 데이터를 추출할 수 있는 경우 <code class="language-plaintext highlighter-rouge">true</code>를 반환하고 예외가 발생했다면 <code class="language-plaintext highlighter-rouge">false</code>를 반환</ul></ul><p><br /> <br /> <br /> <br /></p><h2 id="5-refreshtoken-및-로그아웃-구현"><span class="me-2">5. RefreshToken 및 로그아웃 구현</span><a href="#5-refreshtoken-및-로그아웃-구현" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="-회원가입-시-refreshtoken-저장-토큰-재발급-테스트"><span class="me-2">🔆 회원가입 시 refreshToken 저장, 토큰 재발급 테스트</span><a href="#-회원가입-시-refreshtoken-저장-토큰-재발급-테스트" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><span class="path">ApiV1MemberController</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">MemberRequest</span> <span class="n">memberRequest</span><span class="o">,</span>
        <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="n">memberService</span><span class="o">.</span><span class="na">getMember</span><span class="o">(</span><span class="n">memberRequest</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    
      <span class="c1">// 토큰 생성</span>
      <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jwtProvider</span><span class="o">.</span><span class="na">genAccessToken</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
    
      <span class="c1">// 응답 데이터에 accessToken 이름으로 토큰을 발급</span>
      <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setSecure</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    
      <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="na">getRefreshToken</span><span class="o">();</span>
      <span class="nc">Cookie</span> <span class="n">refreshTokenCookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"refreshToken"</span><span class="o">,</span> <span class="n">refreshToken</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setHttpOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setSecure</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">refreshTokenCookie</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"로그인에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li>최초의 로그인을 하면 <span class="red">사용자</span>에게 <span class="back">AccessToken, RefreshToken</span>을 모두 쿠키로 전달한다.<ul><li>member로 부터 <span class="purple">DB에 저장된 refreshToken</span>을 가져와서 새로운 쿠키를 만든다.<li>쿠키 옵션 설정   (AccessToken 쿠키 설정과 동일)</ul></ul></ul><p><br /></p><p><br /></p><p><br /></p><h3 id="-로그아웃"><span class="me-2">🔆 로그아웃</span><a href="#-로그아웃" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><span class="path">ApiV1MemberController</span></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="복사되었습니다!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RsData</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="nf">logout</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    
      <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"accessToken"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    
      <span class="nc">Cookie</span> <span class="n">refreshTokenCookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"refreshToken"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
      <span class="n">refreshTokenCookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">refreshTokenCookie</span><span class="o">);</span>
    
      <span class="k">return</span> <span class="k">new</span> <span class="nc">RsData</span><span class="o">&lt;&gt;(</span><span class="s">"200"</span><span class="o">,</span> <span class="s">"로그아웃에 성공하였습니다."</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><ul><li>방법은 <span class="pinkback">쿠키를 다 없애는 것</span>이다. <span class="blue">인증/인가</span>를 쿠키로 하고 있기 때문이다.<ul><li>기존에 쿠키를 설정하는 것과 동일하다. 다만 <code class="language-plaintext highlighter-rouge">null</code>을 넘긴다.<li><p>다른 쿠키 설정은 필요 없고 <strong><code class="language-plaintext highlighter-rouge">setPath()</code></strong>와 <strong><code class="language-plaintext highlighter-rouge">setMaxAge()</code></strong>만 <span class="red">0으로 설정</span>한다.</p><p>⇒   쿠키가 제거된다.</p></ul></ul></ul><p><br /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/%EB%A9%8B%EC%9F%81%EC%9D%B4-%EC%82%AC%EC%9E%90%EC%B2%98%EB%9F%BC/">멋쟁이 사자처럼</a>, <a href="/categories/spring-boot/">Spring Boot</a>, <a href="/categories/spring-security/">Spring Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/%EB%A9%8B%EC%9F%81%EC%9D%B4-%EC%82%AC%EC%9E%90%EC%B2%98%EB%9F%BC/" class="post-tag no-text-decoration" >멋쟁이 사자처럼</a> <a href="/tags/spring-security/" class="post-tag no-text-decoration" >Spring Security</a> <a href="/tags/jwt/" class="post-tag no-text-decoration" >JWT</a> <a href="/tags/springconfig/" class="post-tag no-text-decoration" >SpringConfig</a> <a href="/tags/%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EB%A1%9C%EA%B7%B8%EC%95%84%EC%9B%83/" class="post-tag no-text-decoration" >로그인/로그아웃</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> 이 기사는 저작권자의 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 라이센스를 따릅니다.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">공유하기</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=JWT%20%EC%9D%B8%EC%A6%9D%20/%20%EC%9D%B8%EA%B0%80%20-%20%EB%A6%AC%EB%B2%84&url=https%3A%2F%2Fbacknback.github.io%2Fposts%2Fjwt%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=JWT%20%EC%9D%B8%EC%A6%9D%20/%20%EC%9D%B8%EA%B0%80%20-%20%EB%A6%AC%EB%B2%84&u=https%3A%2F%2Fbacknback.github.io%2Fposts%2Fjwt%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fbacknback.github.io%2Fposts%2Fjwt%2F&text=JWT%20%EC%9D%B8%EC%A6%9D%20/%20%EC%9D%B8%EA%B0%80%20-%20%EB%A6%AC%EB%B2%84" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="링크 복사하기" data-title-succeed="링크가 복사되었습니다!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">최근 업데이트</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/member-module-1/">Member 모듈 리펙토링 - 개요 및 진행상황</a><li class="text-truncate lh-lg"> <a href="/posts/member-module-2/">Member 모듈 리펙토링 - 1단계</a><li class="text-truncate lh-lg"> <a href="/posts/spring-security2/">Spring Security 탐구 - 동작 원리</a><li class="text-truncate lh-lg"> <a href="/posts/spring-security/">Spring Security 탐구 - 개요</a><li class="text-truncate lh-lg"> <a href="/posts/jwt/">JWT 인증 / 인가</a></ul></section><section><h2 class="panel-heading">인기 태그</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">Docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/spring-security/">Spring Security</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EB%A9%8B%EC%9F%81%EC%9D%B4-%EC%82%AC%EC%9E%90%EC%B2%98%EB%9F%BC/">멋쟁이 사자처럼</a> <a class="post-tag btn btn-outline-primary" href="/tags/mysql/">MySQL</a> <a class="post-tag btn btn-outline-primary" href="/tags/refactoring/">Refactoring</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9D%B8%EC%A6%9D-%EC%9D%B8%EA%B0%80/">인증/인가</a> <a class="post-tag btn btn-outline-primary" href="/tags/grasp/">GRASP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ncp/">NCP</a> <a class="post-tag btn btn-outline-primary" href="/tags/server/">Server</a> <a class="post-tag btn btn-outline-primary" href="/tags/springconfig/">SpringConfig</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 mb-2">바로가기</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">관련된 글</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/spring-security2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1739592000" data-df="YYYY/MM/DD" > 2025/02/15 </time><h4 class="pt-0 my-2">Spring Security 탐구 - 동작 원리</h4><div class="text-muted"><p>세부 내용 이전에 전체적인 내부 동작 원리를 파악하기</p></div></div></a></article><article class="col"> <a href="/posts/spring-security/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1739505600" data-df="YYYY/MM/DD" > 2025/02/14 </time><h4 class="pt-0 my-2">Spring Security 탐구 - 개요</h4><div class="text-muted"><p>프로젝트에서 경험한 Spring Security에 대하여 더 알고 싶어 공부하는 글글</p></div></div></a></article><article class="col"> <a href="/posts/member-module-2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1739768400" data-df="YYYY/MM/DD" > 2025/02/17 </time><h4 class="pt-0 my-2">Member 모듈 리펙토링 - 1단계</h4><div class="text-muted"><p>프로젝트 때 만든 Member 모듈을 재사용이 가능하도록 완성하는 과정</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/springboot-jpa-basic/" class="btn btn-outline-primary" aria-label="이전 글" ><p>점프 투 스프링부트 2장</p></a> <a href="/posts/spring-security/" class="btn btn-outline-primary" aria-label="다음 글" ><p>Spring Security 탐구 - 개요</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/backnback">이가람</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="명시되지 않는 한 이 사이트의 블로그 게시물은 작성자의 Creative Commons Attribution 4.0 International(CC BY 4.0) 라이선스에 따라 사용이 허가되었습니다." >일부 권리 보유</span></p><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">인기 태그</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">Docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/spring-security/">Spring Security</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EB%A9%8B%EC%9F%81%EC%9D%B4-%EC%82%AC%EC%9E%90%EC%B2%98%EB%9F%BC/">멋쟁이 사자처럼</a> <a class="post-tag btn btn-outline-primary" href="/tags/mysql/">MySQL</a> <a class="post-tag btn btn-outline-primary" href="/tags/refactoring/">Refactoring</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9D%B8%EC%A6%9D-%EC%9D%B8%EA%B0%80/">인증/인가</a> <a class="post-tag btn btn-outline-primary" href="/tags/grasp/">GRASP</a> <a class="post-tag btn btn-outline-primary" href="/tags/ncp/">NCP</a> <a class="post-tag btn btn-outline-primary" href="/tags/server/">Server</a> <a class="post-tag btn btn-outline-primary" href="/tags/springconfig/">SpringConfig</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">새 버전의 콘텐츠를 사용할 수 있습니다.</p><button type="button" class="btn btn-primary" aria-label="Update"> 업데이트 </button></div></aside><script> (function () { const origin = 'https://utteranc.es'; const themeMapper = Theme.getThemeMapper('github-light', 'github-dark'); const initTheme = themeMapper[Theme.visualState]; let script = document.createElement('script'); script.src = 'https://utteranc.es/client.js'; script.setAttribute('repo', 'backnback/comments'); script.setAttribute('issue-term', 'pathname'); script.setAttribute('theme', initTheme); script.crossOrigin = 'anonymous'; script.async = true; const $footer = document.querySelector('footer'); $footer.insertAdjacentElement('beforebegin', script); addEventListener('message', (event) => { let newTheme;if (event.source === window && event.data && event.data.id === Theme.ID) { newTheme = themeMapper[Theme.visualState]; const message = { type: 'set-theme', theme: newTheme }; const utterances = document.querySelector('.utterances-frame').contentWindow; utterances.postMessage(message, origin); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">검색 결과가 없습니다.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
